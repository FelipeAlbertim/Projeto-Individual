<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valorant's Club | Quiz</title>

    <script src="./js/sessao.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gaugeJS"></script>

    <link rel="icon" href="assets/icon/icon.jpg">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="./css/style-questionario.css">
</head>

<body>
    <div id="nav_bar">
        <div id="logo">
            <div id="foto">
                <img src="assets/icon/logo.png">
            </div>
            <div id="valorant">
                <img src="assets/icon/valorant.png">
            </div>
        </div>

        <div id="menu">
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="index.html#agentes">Agentes</a></li>
                <li><a href="index.html#mapas">Mapas</a></li>
                <li class="btn" id="btn_sair" onclick="limparSessao()">Sair</li>
            </ul>
        </div>
    </div>

    <div class="container">
        <div id="introducao" style="display: flex;">
            <!-- <div id="introducao" style="display: none;"> -->
            <div class="textoIntrodutorio">
                <h1 class="textoCentralizado"> Ol√°, <span id="span_nome"></span> </h1>
                <h2 style="padding-bottom: 20px;"> Como funciona o quiz:</h2>
                <ol>
                    <li>O quiz tem 10 perguntas de m√∫ltipla escolha, todas sobre Valorant, √© claro!</li>
                    <li>Escolha a resposta que voc√™ acha certa. N√£o se preocupe, ningu√©m vai julgar se voc√™ errar.</li>
                    <li>Voc√™ tem 2 minutos para responder todas as perguntas, mas sem estresse, ok?</li>
                    <li>Responda todas as perguntas antes que o tempo acabe. Se n√£o der tempo, o quiz vai encerrar
                        sozinho.</li>
                    <li>Sua pontua√ß√£o e seu elo ser√° baseada no n√∫mero de respostas corretas.</li>
                    <li>Se empatar com algu√©m, quem terminar mais r√°pido ganha mais pontos!</li>
                    <li>O resultado aparece na hora. Ser√° que voc√™ √© um verdadeiro mestre de Valorant?</li>
                    <li>Divirta-se e jogue!</li>
                </ol>
            </div>
            <button class="start" onclick="escondeIntrucao(), atualizarPergunta()"
                style="font-size: 20px;">Come√ßar</button>
        </div>

        <div id="questao" style="display: none;">
            <span>
                <h1 id="pergunta">Lorem ipsum dolor sit amet.</h1>
            </span>
            <div class="respostas">
                <span class="resposta" id="Resposta_1" onclick="selecionarResposta(1)">Lorem, ipsum.</span>
                <span class="resposta" id="Resposta_2" onclick="selecionarResposta(2)">Lorem, ipsum.</span>
                <span class="resposta" id="Resposta_3" onclick="selecionarResposta(3)">Lorem, ipsum.</span>
                <span class="resposta" id="Resposta_4" onclick="selecionarResposta(4)">Lorem, ipsum.</span>
            </div>
            <button id="proxima_pergunta" onclick="confirmarResposta()">Pr√≥xima Pergunta !</button>
        </div>

        <div id="fim" style="display: none;">

            <div class="graficos">

                <div class="dash">

                    <div id="tempo">
                        <h1 style="color: white;">Tempo (Segundos)</h1>
                        <p style="color: white;"> Tempo de prova -> <span id="spanSegundos">Error</span> Segundos</p>

                        <canvas id="dash_tempo"></canvas>
                    </div>

                    <div id="acertos">
                        <h1 style="color: white;">Acertos</h1>
                        <p style="color: white;"> Acertos -> <span id="spanAcertos"></span></p>

                        <canvas id="dash_acertos"></canvas>

                    </div>
                </div>

                <div id="botao">
                    <button class="start"
                    onclick="inserirResultados()">COMPARATIVO</button>
                    </div>
            </div>
        </div>

        <div id="graficosComparativos" class="graficos" style="display: none;">

            <div id="titulo_graficos">
                <h1> ü´µ Voc√™ X Mundo üåé </h1>
            </div>git

            <div class="graficos1">

                <div id="grafico_comparativo_tempo">
                    <canvas id="comparativoTempo"></canvas>
                </div>

                <div id="grafico_comparativo_elo">
                    <canvas id="comparativoGlobal1"></canvas>
                </div>
            </div>

        </div>

    </div>


    </div>
</body>

</html>

<script>
    span_nome.innerHTML = sessionStorage.NOME_USUARIO;

    var idUsuario = sessionStorage.ID_USUARIO;

    var tempoSegundos = 0
    var tempoInicioQuiz = 0;
    var fazendoQuiz = false

    function escondeIntrucao() {
        introducao.style.display = 'none';
        questao.style.display = 'block';
        if (fazendoQuiz = true) {
            counter = setInterval(tempo, 1000)
        }

        function tempo() {
            tempoSegundos += 1000; //
        }
        tempoInicioQuiz = Date.now();
    }

    var respostaSelecionada = null;
    var textoRespostaSelecionada = null;
    var textoRespostaCorreta = ""
    var counter;

    function selecionarResposta(respostaId) {
        respostaSelecionada = respostaId;
        textoRespostaSelecionada = document.getElementById(`Resposta_${respostaId}`).innerText;
        document.querySelectorAll('.resposta').forEach(element => {
            element.style.backgroundColor = '';
        });
        document.getElementById(`Resposta_${respostaId}`).style.backgroundColor = 'lightblue';
    }

    var totalPerguntas = 0
    var perguntaAtual = 0;
    var tempoInicioPergunta = 0;
    var acertos = 0

    function atualizarPergunta() {
        fazendoQuiz = true;
        tempoInicioPergunta = Date.now();
        fetch("/avisos/listarPergunta").then(function (resposta) {
            if (resposta.ok) {
                if (resposta.status == 204) {
                    throw "Nenhum resultado encontrado!!";
                }
                resposta.json().then(function (resposta) {
                    totalPerguntas = resposta.length
                    var textoPergunta = resposta[perguntaAtual];
                    if (textoPergunta && textoPergunta.textoPergunta) {
                        pergunta.innerHTML = `${perguntaAtual + 1}. ${textoPergunta.textoPergunta}`;
                        perguntaAtual++;
                        atualizarResposta();
                    } else {
                        fazendoQuiz = false
                        clearInterval(counter);
                        questao.style.display = "none"
                        fim.style.display = "flex"
                        spanSegundos.innerHTML = tempoSegundos
                        spanAcertos.innerHTML = acertos
                        spanAcertos.innerHTML += ` / ${totalPerguntas}`
                        imprimirGraficosResultado();
                    }
                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (erro) {
            console.error(erro);
        });
    }

    function atualizarResposta() {
        fazendoQuiz = true
        fetch(`/avisos/listarResposta/${perguntaAtual}`).then(function (resposta) {
            if (resposta.ok) {
                if (resposta.status == 204) {
                    throw "Nenhum resultado encontrado!!";
                }
                totalPerguntas = resposta.length
                resposta.json().then(function (resposta) {
                    for (var i = 0; i < resposta.length; i++) {
                        var textoResposta = resposta[i].textoResposta;
                        var box_resposta_id = `Resposta_${i + 1}`;
                        var box_resposta = document.getElementById(box_resposta_id);
                        box_resposta.innerHTML = textoResposta;
                        box_resposta.style.backgroundColor = '';

                        if (resposta[i].correta == true) {
                            textoRespostaCorreta = textoResposta
                        }
                    }
                    respostaSelecionada = null;
                    textoRespostaSelecionada = null;
                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });
    }

    var listaDiferencaTempo = []
    var tempoFimPergunta = 0;

    function confirmarResposta() {
        tempoFimPergunta = Date.now();
        var tempoGastoPergunta = (tempoFimPergunta - tempoInicioPergunta) / 1000;
        listaDiferencaTempo.push(tempoGastoPergunta);

        fazendoQuiz = true
        if (respostaSelecionada == null) {
            alert("Por favor, selecione uma resposta.");
        } else {
            if (textoRespostaSelecionada == textoRespostaCorreta) {
                acertos++
            }
            console.log(`Resposta selecionada para a pergunta ${perguntaAtual}: ${textoRespostaSelecionada}`);
            console.log(`Quantidade acertos: ${acertos}`);
            atualizarPergunta();
        }
    }
    var tempoTotalQuiz = 0
    function imprimirGraficosResultado() {
        var ctxAcertos = document.getElementById('dash_acertos');

        new Chart(ctxAcertos, {
            type: 'doughnut',
            data: {
                labels: ['Erros', 'Acertos'],
                datasets: [{
                    label: 'Acertos',
                    data: [totalPerguntas - acertos, acertos],
                    backgroundColor: [
                        'rgb(255, 0, 0)',
                        'rgb(0, 255, 0)'
                    ],
                    borderColor: [
                        'rgba(255, 0, 0, 1)',
                        'rgba(0, 255, 0, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        display: false
                    }
                },
                plugins: {
                    legend: {
                        padding: 20

                    }
                }
            }
        });

        const ctx = document.getElementById('dash_tempo');
        var posicoes = [];
        for (var i = 0; i < listaDiferencaTempo.length; i++) {
            posicoes.push(i + 1);
        }

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: posicoes,
                datasets: [{
                    label: 'Tempo por Pergunta (Milissegundos)',
                    data: listaDiferencaTempo,
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                    },
                }
            }
        });
        var tempoFimQuiz = Date.now();
        tempoTotalQuiz = (tempoFimQuiz - tempoInicioQuiz) / 1000;
        spanSegundos.innerHTML = tempoTotalQuiz.toFixed(2);
    }

    function imprimirGraficosComparativos() {
        fim.style.display = "none"
        introducao.style.display = "none"
        questao.style.display = "none"
        graficosComparativos.style.display = "flex"

        const comparativoTempo = document.getElementById('comparativoTempo');

        new Chart(comparativoTempo, {
            type: 'bar',
            data: {
                labels: ['M√≠nimo', 'Tempo M√©dio', 'Seu Tempo', 'M√°ximo'],
                datasets: [{
                    label: ['Gr√°fico de tempo m√©dio (segundos)'],
                    data: data,
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            color: 'white'
                        },
                        ticks: {
                            color: 'white'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            color: 'white'
                        },
                        ticks: {
                            color: 'white'
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: 'white',

                        }
                    }
                }
            }
        });

        const comparativoGlobal1 = document.getElementById('comparativoGlobal1');

        new Chart(comparativoGlobal1, {
            type: 'pie',
            data: {
                labels: ['RADIANTE', 'IMORTAL', 'ASCENDENTE', 'DIAMANTE', 'PLATINA', 'OURO', 'PRATA', 'FERRO'],
                datasets: [{
                    label: 'Jogadores',
                    data: [3, 6, 12, 17, 20, 19, 10, 2],
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        display: false,
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: 'white',
                        }
                    }
                }
            }
        });
    }

    function inserirResultados() {

        fetch("/quiz/cadastrar", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                fkUsuarioServer: idUsuario,
                tempoTentativaServer: tempoTotalQuiz,
                pontuacaoServer: acertos
            }),
        })
            .then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    console.log(resposta)
                    obterDadosGrafico(idUsuario)
                } else {
                    throw "Houve um erro ao tentar realizar o cadastro!";
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });

        return false;

        
    }

    var data = []
    function obterDadosGrafico(idUsuario) {

            fetch(`/quiz/listar/${idUsuario}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

                    console.log(`CONTEUDO ANTES DE MANDAR PARA A RESPOSTA - MINIMO DE TEMPO ${JSON.stringify(resposta[0])}`)

                    data.push(resposta[0].minTempo)
                    data.push(resposta[0].mediaTempo)
                    data.push(resposta[0].tentativaTempo)
                    data.push(resposta[0].maxTempo)
                    console.log(data)
                    imprimirGraficosComparativos()

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obten√ß√£o dos dados p/ gr√°fico: ${error.message}`);
            });
    }

</script>