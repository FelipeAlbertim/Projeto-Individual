<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valorant's Club | Quiz</title>

    <script src="./js/sessao.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gaugeJS"></script>

    <link rel="icon" href="assets/icon/icon.jpg">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="./css/style-questionario.css">
    <style>
        canvas {
            width: 400px !important;
            height: 400px !important;
        }
    </style>
</head>

<body>
    <div id="nav_bar">
        <div id="logo">
            <div id="foto">
                <img src="assets/icon/logo.png">
            </div>
            <div id="valorant">
                <img src="assets/icon/valorant.png">
            </div>
        </div>

        <div id="menu">
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="index.html#agentes">Agentes</a></li>
                <li><a href="index.html#mapas">Mapas</a></li>
                <li class="btn" id="btn_sair" onclick="limparSessao()">Sair</li>
            </ul>
        </div>
    </div>

    <div class="container">
        <div id="introducao" style="display: block;">
            <div class="textoIntrodutorio">
                <h1 class="textoCentralizado"> Olá, <span id="span_nome"></span> </h1>
                <h2 style="padding-bottom: 20px;"> Como funciona o quiz:</h2>
                <ol>
                    <li>O quiz tem 10 perguntas de múltipla escolha, todas sobre Valorant, é claro!</li>
                    <li>Escolha a resposta que você acha certa. Não se preocupe, ninguém vai julgar se você errar.</li>
                    <li>Você tem 2 minutos para responder todas as perguntas, mas sem estresse, ok?</li>
                    <li>Responda todas as perguntas antes que o tempo acabe. Se não der tempo, o quiz vai encerrar
                        sozinho.</li>
                    <li>Sua pontuação e seu elo será baseada no número de respostas corretas.</li>
                    <li>Se empatar com alguém, quem terminar mais rápido ganha mais pontos!</li>
                    <li>O resultado aparece na hora. Será que você é um verdadeiro mestre de Valorant?</li>
                    <li>Divirta-se e jogue!</li>
                </ol>
            </div>
            <button id="start" onclick="escondeIntrucao(), atualizarPergunta()">Começar</button>
        </div>

        <div id="questao" style="display: none;">
            <span>
                <h1 id="pergunta">Lorem ipsum dolor sit amet.</h1>
            </span>
            <div class="respostas">
                <span class="resposta" id="Resposta_1" onclick="selecionarResposta(1)">Lorem, ipsum.</span>
                <span class="resposta" id="Resposta_2" onclick="selecionarResposta(2)">Lorem, ipsum.</span>
                <span class="resposta" id="Resposta_3" onclick="selecionarResposta(3)">Lorem, ipsum.</span>
                <span class="resposta" id="Resposta_4" onclick="selecionarResposta(4)">Lorem, ipsum.</span>
            </div>
            <button id="proxima_pergunta" onclick="confirmarResposta()">Próxima Pergunta !</button>
        </div>

        <div id="fim" style="display: none;">
            <div id="graficos">
                <div id="tempo" class="dash">
                    <h1 style="color: white;">Tempo (Segundos)</h1>
                    <p style="color: white;"> Tempo de prova -> <span id="spanSegundos">Error</span> Segundos</p>
                    <div>
                        <canvas id="dash_tempo" style="height: auto; width: 600px;"></canvas>
                    </div>
                </div>
                <div id="acertos" class="dash">
                    <h1 style="color: white;">Acertos</h1>
                    <p style="color: white;"> Acertos -> <span id="spanAcertos"></span></p>
                    <div>
                        <canvas id="dash_acertos"></canvas>
                    </div>
                </div>
            </div>
            <div id="botao">
                <button>PRÓXIMO DASH</button>
            </div>
        </div>
    </div>

    <script>
        var nome_usuario = sessionStorage.NOME_USUARIO;

        var perguntaAtual = 0;
        var respostaSelecionada = null;
        var textoRespostaSelecionada = null;
        var textoRespostaCorreta = ""
        var counter;

        var tempoSegundos = 0
        var tempoQuestao = 0
        var tempoAnterior = 0
        var listaDiferencaTempo = []

        var tempoInicioPergunta = 0;
        var tempoFimPergunta = 0;

        var tempoInicioQuiz = 0;
        var fazendoQuiz = false
        var acertos = 0
        var totalPerguntas = 0



        span_nome.innerHTML += `${nome_usuario} !`;

        function escondeIntrucao() {
            introducao.style.display = 'none';
            questao.style.display = 'block';
            if (fazendoQuiz = true) {
                counter = setInterval(tempo, 1000)
            }

            function tempo() {
                tempoSegundos += 1000; // Incrementa em milissegundos
            }
            tempoInicioQuiz = Date.now(); // Armazena o tempo de início do quiz
        }

        function selecionarResposta(respostaId) {
            respostaSelecionada = respostaId;
            textoRespostaSelecionada = document.getElementById(`Resposta_${respostaId}`).innerText;
            document.querySelectorAll('.resposta').forEach(element => {
                element.style.backgroundColor = ''; // Reset background color
            });
            document.getElementById(`Resposta_${respostaId}`).style.backgroundColor = 'lightblue'; // Highlight selected
        }

        function atualizarPergunta() {
            fazendoQuiz = true;
            tempoInicioPergunta = Date.now(); // Armazena o tempo de início da pergunta

            fetch("/avisos/listarPergunta").then(function (resposta) {
                if (resposta.ok) {
                    if (resposta.status == 204) {
                        throw "Nenhum resultado encontrado!!";
                    }
                    resposta.json().then(function (resposta) {
                        totalPerguntas = resposta.length
                        var textoPergunta = resposta[perguntaAtual];
                        if (textoPergunta && textoPergunta.textoPergunta) {
                            pergunta.innerHTML = `${perguntaAtual + 1}. ${textoPergunta.textoPergunta}`;
                            perguntaAtual++;
                            atualizarResposta();
                        } else {
                            // TERMINOU O QUIZ
                            fazendoQuiz = false
                            clearInterval(counter); // Stop the timer
                            questao.style.display = "none"
                            fim.style.display = "flex"
                            spanSegundos.innerHTML = tempoSegundos
                            spanAcertos.innerHTML = acertos
                            spanAcertos.innerHTML += ` / ${totalPerguntas}`
                            imprimirGraficos(); // Chama a função para imprimir os gráficos
                        }
                    });
                } else {
                    throw ('Houve um erro na API!');
                }
            }).catch(function (erro) {
                console.error(erro);
            });
        }

        function atualizarResposta() {
            fazendoQuiz = true
            fetch(`/avisos/listarResposta/${perguntaAtual}`).then(function (resposta) {
                if (resposta.ok) {
                    if (resposta.status == 204) {
                        throw "Nenhum resultado encontrado!!";
                    }
                    totalPerguntas = resposta.length
                    resposta.json().then(function (resposta) {
                        for (var i = 0; i < resposta.length; i++) {
                            var textoResposta = resposta[i].textoResposta;
                            var box_resposta_id = `Resposta_${i + 1}`;
                            var box_resposta = document.getElementById(box_resposta_id);
                            box_resposta.innerHTML = textoResposta;
                            box_resposta.style.backgroundColor = ''; // Reset background color for new answers

                            if (resposta[i].correta == true) {
                                textoRespostaCorreta = textoResposta
                            }
                        }
                        respostaSelecionada = null; // Reset selected answer
                        textoRespostaSelecionada = null; // Reset selected answer text
                    });
                } else {
                    throw ('Houve um erro na API!');
                }
            }).catch(function (resposta) {
                console.error(resposta);
            });
        }

        function confirmarResposta() {
            tempoFimPergunta = Date.now(); // Armazena o tempo de término da pergunta
            var tempoGastoPergunta = (tempoFimPergunta - tempoInicioPergunta) / 1000; // Calcula o tempo gasto em segundos
            listaDiferencaTempo.push(tempoGastoPergunta); // Adiciona o tempo gasto à lista

            fazendoQuiz = true
            if (respostaSelecionada == null) {
                alert("Por favor, selecione uma resposta.");
            } else {
                if (textoRespostaSelecionada == textoRespostaCorreta) {
                    acertos++
                }
                console.log(`Resposta selecionada para a pergunta ${perguntaAtual}: ${textoRespostaSelecionada}`);
                console.log(`Quantidade acertos: ${acertos}`);
                atualizarPergunta();
            }
        }

        function imprimirGraficos() {
            var ctxAcertos = document.getElementById('dash_acertos');

            new Chart(ctxAcertos, {
                type: 'doughnut',
                data: {
                    labels: ['Erros', 'Acertos'],
                    datasets: [{
                        label: 'Acertos',
                        data: [totalPerguntas - acertos, acertos],
                        backgroundColor: [
                            'rgb(255, 0, 0)',
                            'rgb(0, 255, 0)'
                        ],
                        borderColor: [
                            'rgba(255, 0, 0, 1)',     // Vermelho para erros
                            'rgba(0, 255, 0, 1)'    // Azul para acertos
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            display: false  // Desabilita o eixo Y
                        }
                    },
                    plugins: {
                        legend: {
                            padding: 20  // Adiciona um espaçamento entre
                        }
                    }
                }
            });

            const ctx = document.getElementById('dash_tempo');
            var posicoes = [];
            for (var i = 0; i < listaDiferencaTempo.length; i++) {
                posicoes.push(i + 1);
            }

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: posicoes,
                    datasets: [{
                        label: 'Tempo por Pergunta (Milissegundos)',
                        data: listaDiferencaTempo,
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            var tempoFimQuiz = Date.now(); // Armazena o tempo de término do quiz
            var tempoTotalQuiz = (tempoFimQuiz - tempoInicioQuiz) / 1000; // Calcula o tempo total do quiz em segundos
            spanSegundos.innerHTML = tempoTotalQuiz.toFixed(2); // Exibe o tempo total do quiz em segundos sem arredondamento
        }
    </script>
</body>

</html>